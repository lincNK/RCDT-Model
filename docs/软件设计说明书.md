# RCDT 全脑动力学拓扑分析系统

## 软件设计说明书

**版本**：V1.1  
**著作权人**：Haolong Wang  
**开发完成日期**：2026年2月（V1.0）；2026年2月修订（V1.1）  
**文档类型**：软件著作权登记 – 设计说明书

---

## 目录

1. [引言](#1-引言)
   - 1.1 编写目的
   - 1.2 背景与范围
   - 1.3 术语与缩略语
   - 1.4 参考资料
2. [功能架构](#2-功能架构)
   - 2.1 系统总体架构
   - 2.2 数据模拟引擎
   - 2.3 拓扑分析模块
   - 2.4 可视化仪表板
   - 2.5 模块调用关系与数据流
3. [操作指南](#3-操作指南)
   - 3.1 运行环境与安装
   - 3.2 用户工作流程
   - 3.3 命令行接口说明
   - 3.4 典型操作场景
   - 3.5 运行环境详细配置
   - 3.6 常见问题与故障排除
4. [输入输出规格](#4-输入输出规格)
   - 4.1 输入规格
   - 4.2 输出规格
   - 4.3 参数配置表
5. [文件结构说明](#5-文件结构说明)
6. [版本历史与维护](#6-版本历史与维护)
7. [附录](#7-附录)

---

## 1. 引言

### 1.1 编写目的

本说明书旨在对「RCDT 全脑动力学拓扑分析系统」（以下简称「本系统」或「RCDT 系统」）的软件设计、功能架构及操作流程进行规范描述。本系统是一套面向计算神经科学研究的应用软件，实现受体约束动力学拓扑（Receptor-Constrained Dynamical Topology, RCDT）假说的数值验证与分析流程。本文档供软件著作权登记、技术维护及用户培训使用。

### 1.2 背景与范围

本系统将神经药理学的受体密度分布与全脑动力学的拓扑特征建立可计算映射，通过以下核心能力实现功能目标：

- **数据模拟**：基于 Wilson-Cowan 兴奋-抑制神经网络模型，在结构连接网络上进行动力学仿真，并引入受体加权的增益调制；
- **拓扑分析**：基于 Takens 时间延迟嵌入与 Vietoris-Rips 持久同调，从标量时间序列中提取持久图与持久熵；
- **可视化呈现**：生成脑网络图、持久图、浓度-拓扑响应曲线等科学图表。

本系统的应用范围涵盖：全脑动力学仿真、药物浓度-拓扑关系分析、TDA 管道校验，以及预印本/论文图表的批量生成。

### 1.3 术语与缩略语

| 术语/缩略语 | 全称/说明 |
|-------------|-----------|
| RCDT | Receptor-Constrained Dynamical Topology，受体约束动力学拓扑 |
| TDA | Topological Data Analysis，拓扑数据分析 |
| SC | Structural Connectivity，结构连接 |
| PE | Persistent Entropy，持久熵 |
| H₀ / H₁ | 0 维 / 1 维同调群（连通分量 / 环） |
| [D] | 药物浓度算子 |

### 1.4 参考资料

- `RCDT_bioRxiv_manuscript.md`：本系统的理论与方法论文稿
- `README.md`：项目概述与快速入门
- `requirements.txt`：Python 依赖清单

---

## 2. 功能架构

### 2.1 系统总体架构

本系统采用模块化设计，由三个功能子系统和若干工具脚本构成：

```
┌─────────────────────────────────────────────────────────────────┐
│                    RCDT 全脑动力学拓扑分析系统                     │
├─────────────────────────────────────────────────────────────────┤
│  数据模拟引擎         拓扑分析模块           可视化仪表板          │
│  (Wilson-Cowan)      (Takens + Ripser)     (Matplotlib)         │
├──────────────┬──────────────┬──────────────┬────────────────────┤
│ figure2_     │ figure1_     │ figure2_     │ create_            │
│ simulation   │ persistence_ │ simulation   │ supplementary_     │
│ .py          │ diagram.py   │ .py          │ pdf.py             │
└──────────────┴──────────────┴──────────────┴────────────────────┘
```

**主程序文件**：

| 文件名 | 功能概述 |
|--------|----------|
| `figure1_persistence_diagram.py` | TDA 管道校验（Van der Pol vs Lorenz） |
| `figure2_simulation.py` | 全脑模型仿真、受体洗牌控制、分岔扫描、主图与持久熵图生成 |
| `create_supplementary_pdf.py` | 补充材料 PDF 合成 |

### 2.2 数据模拟引擎

**实现位置**：`figure2_simulation.py`

数据模拟引擎实现 Wilson-Cowan 兴奋-抑制（E-I）神经网络质量模型的数值积分，并支持：

- **结构连接矩阵**：30×30 对称矩阵，经单位谱半径归一化；
- **轴突延迟**：τ_{ij} = D_{ij} / v，v = 5 mm/ms；
- **受体加权增益**：G_i = G_0 + k · ρ_i · [D]，其中 ρ_i 为 5-HT2A 受体密度；
- **随机积分**：Euler-Maruyama 格式，带布朗噪声项，防止系统陷于稳定不动点；
- **受体洗牌控制**：对 ρ 进行随机置换，用于机制隔离。

**核心函数**：

- `create_synthetic_sc()`：生成合成结构连接矩阵
- `create_synthetic_receptor_map()`：生成合成受体密度图
- `run_wilson_cowan()`：执行 Wilson-Cowan 积分，输出兴奋性活动时间序列
- `shuffle_receptor_map()`：受体洗牌
- `run_bifurcation_sweep()`：分岔参数扫描（k vs 持久熵）

### 2.3 拓扑分析模块

**实现位置**：`figure1_persistence_diagram.py`、`figure2_simulation.py`

拓扑分析模块实现 Takens 嵌入与持久同调计算：

- **时间序列生成**：Van der Pol、Lorenz 系统的 ODE 积分（figure1）；全脑平均兴奋性信号（figure2）；
- **Takens 嵌入**：X(t) = [x(t), x(t+τ), …, x(t+(m-1)τ)]，m=3；
- **Vietoris-Rips 复形**：基于 Ripser 库计算持久同调；
- **持久熵**：PE = -Σ p_i log p_i，量化拓扑复杂度。

**核心函数**：

- `takens_embedding()`：时间延迟嵌入
- `compute_persistence()`：持久同调计算（Ripser）
- `persistent_entropy()`：持久熵计算
- `subsample_point_cloud()`：点云降采样（计算效率）

### 2.4 可视化仪表板

**实现位置**：`figure1_persistence_diagram.py`、`figure2_simulation.py`、`create_supplementary_pdf.py`

可视化仪表板基于 Matplotlib，生成下列图表：

- **Figure 1**：2×2 面板，Van der Pol / Lorenz 重构相空间与持久图；
- **Figure 2**：脑网络图（节点着色为受体密度）+ 多浓度持久图；
- **Figure 3**：持久熵 vs 药物浓度 [D] 曲线；
- **补充图**：受体洗牌对照图、分岔扫描图；
- **PDF 合成**：将补充图合并为 `RCDT_supplementary.pdf`。

**输出目录**：`figs/`

### 2.5 模块调用关系与数据流

本系统各模块之间的调用关系及数据流向如下：

**主流程（figure2_simulation.py）**：

```
create_synthetic_sc() ──┬──► C (结构连接), D (距离)
                        │
create_synthetic_receptor_map() ──► ρ (受体密度)
                        │
                        ▼
run_wilson_cowan(C, D, ρ, [D]) ──► E_trajectory (兴奋性时间序列)
                        │
                        ▼
global_mean_E(E_trajectory) ──► x (标量时间序列)
                        │
                        ▼
takens_embedding(x) ──► X (点云)
                        │
                        ▼
subsample_point_cloud(X) ──► X_sub
                        │
                        ▼
compute_persistence(X_sub) ──► diagrams (持久图)
                        │
                        ▼
persistent_entropy(diagrams) ──► PE (持久熵)
                        │
                        ▼
_plot_brain_graph(), plot_diagrams() ──► PNG 图像
```

**TDA 校验流程（figure1_persistence_diagram.py）**：

```
van_der_pol / lorenz ──► generate_time_series() ──► x
                                                    │
                                                    ▼
                                          takens_embedding(x)
                                                    │
                                                    ▼
                                          compute_persistence()
                                                    │
                                                    ▼
                                          create_figure1() ──► fig1_tda_validation.png
```

**补充 PDF 流程（create_supplementary_pdf.py）**：

```
figs/fig2_supp_shuffled_control.png ──┐
                                      ├──► matplotlib 合成 ──► RCDT_supplementary.pdf
figs/fig2_supp_bifurcation_sweep.png ─┘
```

---

## 3. 操作指南

### 3.1 运行环境与安装

**运行环境**：

- Python 3.10 或更高版本
- 操作系统：Windows / macOS / Linux

**依赖包**（见 `requirements.txt`）：

- numpy >= 1.20
- scipy >= 1.7
- matplotlib >= 3.5
- ripser >= 0.6.0
- persim >= 0.3.0

**安装步骤**：

```bash
git clone https://github.com/lincNK/RCDT-Model.git
cd RCDT-Model
pip install -r requirements.txt
```

### 3.2 用户工作流程

```
[安装依赖] → [选择运行模式] → [执行脚本] → [查看 figs/ 输出]
```

| 工作流 | 目标 | 主脚本 | 输出 |
|--------|------|--------|------|
| TDA 校验 | 验证 TDA 对有序/混沌动力学的区分能力 | figure1_persistence_diagram.py | fig1_tda_validation.png |
| 主仿真 | 生成受体加权拓扑重组与持久熵曲线 | figure2_simulation.py | fig2_*.png, fig3_*.png |
| 受体洗牌对照 | 评估 5-HT2A 特异性 | figure2_simulation.py --shuffled | fig2_supp_shuffled_control.png |
| 分岔扫描 | 确定 k_crit 阈值 | figure2_simulation.py --sweep | fig2_supp_bifurcation_sweep.png |
| 补充 PDF | 合成预印本补充材料 | create_supplementary_pdf.py | RCDT_supplementary.pdf |

### 3.3 命令行接口说明

#### 3.3.1 figure1_persistence_diagram.py

无命令行参数。直接执行生成 `figs/fig1_tda_validation.png`。

```bash
python figure1_persistence_diagram.py
```

#### 3.3.2 figure2_simulation.py

| 参数 | 类型 | 说明 |
|------|------|------|
| `--quick` | flag | 快速模式：缩短仿真时间（5 s）、减少浓度点数（3 个）、降低 TDA 采样数；适用于功能验证与调试 |
| `--shuffled` | flag | 执行受体洗牌对照实验；额外生成 fig2_supp_shuffled_control.png |
| `--sweep` | flag | 执行分岔参数扫描；扫描 k ∈ [0.5, 5.0]，输出 k vs PE 曲线及估计的 k_crit；输出 fig2_supp_bifurcation_sweep.png |
| `--output` | str | 主图输出路径；默认为 figs/fig2_receptor_topology.png |

**示例**：

```bash
# 完整主仿真（约 60 s 仿真 × 5 浓度）
python figure2_simulation.py

# 快速验证
python figure2_simulation.py --quick

# 含受体洗牌对照
python figure2_simulation.py --shuffled

# 仅分岔扫描
python figure2_simulation.py --sweep
```

#### 3.3.3 create_supplementary_pdf.py

无命令行参数。将 `figs/fig2_supp_shuffled_control.png` 与 `figs/fig2_supp_bifurcation_sweep.png` 合成 `RCDT_supplementary.pdf`。

```bash
python create_supplementary_pdf.py
```

**前置条件**：需先运行 `figure2_simulation.py --shuffled` 与 `figure2_simulation.py --sweep` 生成上述 PNG 文件。

### 3.4 典型操作场景

**场景 A：复现论文全部图表**

```bash
python figure1_persistence_diagram.py
python figure2_simulation.py --shuffled
python figure2_simulation.py --sweep
python create_supplementary_pdf.py
```

**场景 B：快速功能测试**

```bash
python figure2_simulation.py --quick
```

**场景 C：仅分岔阈值分析**

```bash
python figure2_simulation.py --sweep
```

### 3.5 运行环境详细配置

| 项目 | 最低配置 | 推荐配置 |
|------|----------|----------|
| 操作系统 | Windows 10 / macOS 10.14 / Ubuntu 18.04 | Windows 11 / macOS 12+ / Ubuntu 22.04 |
| Python 版本 | 3.10 | 3.11 或 3.12 |
| 内存 | 4 GB | 8 GB 及以上 |
| 磁盘空间 | 500 MB（含依赖） | 1 GB |
| 依赖安装方式 | `pip install -r requirements.txt` | 建议使用虚拟环境（venv 或 conda） |

**虚拟环境创建示例**：

```bash
python -m venv venv
# Windows:
venv\Scripts\activate
# macOS/Linux:
source venv/bin/activate
pip install -r requirements.txt
```

### 3.6 常见问题与故障排除

| 问题现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| `ModuleNotFoundError: No module named 'ripser'` | 依赖未安装 | 执行 `pip install -r requirements.txt` |
| `ModuleNotFoundError: No module named 'persim'` | persim 未安装 | 执行 `pip install persim`；persim 为可选，缺失时使用内置备用绘图 |
| 运行 figure2_simulation.py 内存占用过高 | 默认仿真时长较长 | 使用 `--quick` 模式缩短仿真时间 |
| figs 目录下无输出图像 | 工作目录错误 | 确保在 Theory 项目根目录下执行脚本 |
| create_supplementary_pdf.py 报错找不到图片 | 未先生成补充图 | 先执行 `figure2_simulation.py --shuffled` 和 `--sweep` |
| 持久熵始终为 0 | 参数 k 过小或系统陷于不动点 | 使用 `--sweep` 扫描 k，选择 PE > 0.01 的参数范围 |

---

## 4. 输入输出规格

### 4.1 输入规格

| 输入项 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| 结构连接矩阵 C | 30×30 float | 对称，单位谱半径归一化 | `create_synthetic_sc()` 合成；可扩展为 HCP 数据 |
| 距离矩阵 D | 30×30 float | 节点间欧氏距离（mm） | 与 C 一同生成 |
| 受体密度向量 ρ | 30×1 float | 归一化至 [0, 1]，高值对应 DMN 样区域 | `create_synthetic_receptor_map()` 合成；可扩展为 Beliveau PET 映射 |
| 药物浓度 [D] | float 列表 | 如 [0, 0.5, 1.0, 1.5, 2.0] | 程序内配置 |
| 嵌入参数 | m=3, τ | 嵌入维数、延迟（样本） | 程序内配置 |

### 4.2 输出规格

| 输出项 | 文件/格式 | 说明 |
|--------|-----------|------|
| TDA 校验图 | figs/fig1_tda_validation.png | 2×2 面板：Van der Pol / Lorenz 相空间与持久图 |
| 主拓扑图 | figs/fig2_receptor_topology.png | 脑网络 + 多浓度持久图 |
| 持久熵曲线 | figs/fig3_persistent_entropy.png | PE vs [D]，支持实验与洗牌对照 |
| 受体洗牌对照 | figs/fig2_supp_shuffled_control.png | 实验 vs 洗牌 PE 曲线对比 |
| 分岔扫描图 | figs/fig2_supp_bifurcation_sweep.png | k vs PE，标注 k_crit |
| 补充材料 PDF | RCDT_supplementary.pdf | 洗牌 + 分岔扫描图合并 |

所有 PNG 图像默认 DPI=150，格式为 PNG。持久图为 (birth, death) 坐标；持久熵为标量浮点数。

### 4.3 参数配置表

本系统核心参数定义于 `figure2_simulation.py`，如下表所示：

| 参数名 | 默认值 | 单位/说明 |
|--------|--------|-----------|
| N_NODES | 30 | 脑区节点数（Schaefer 图谱） |
| TAU_E | 10.0 | ms，兴奋性种群时间常数 |
| TAU_I | 5.0 | ms，抑制性种群时间常数 |
| W_EE | 1.2 | 兴奋-兴奋连接权重 |
| W_IE | 1.0 | 抑制-兴奋连接权重 |
| W_EI | 1.0 | 兴奋-抑制连接权重 |
| W_II | 0.7 | 抑制-抑制连接权重 |
| G_0 | 1.0 | 基线增益 |
| K_GAIN | 2.5 | 受体-增益耦合强度 |
| K_GAIN_RANGE | (0.5, 5.0) | 分岔扫描时 k 的范围 |
| SIGMA_NOISE | 0.02 | Euler-Maruyama 噪声幅值 |
| V_CONDUCTION | 5.0 | mm/ms，轴突传导速度 |
| DT | 0.005 | 积分步长（5 ms） |
| TOTAL_TIME_MS | 60000 | 总仿真时长（60 s） |
| TRANSIENT_MS | 10000 | 瞬态剔除时长（10 s） |
| D_CONCENTRATIONS | [0, 0.5, 1.0, 1.5, 2.0] | 药物浓度序列 |
| 嵌入维数 m | 3 | Takens 嵌入维数 |
| 嵌入延迟 τ | 12~15 | 样本点数，依数据调整 |

---

## 5. 文件结构说明

```
Theory/
├── figure1_persistence_diagram.py   # TDA 校验主程序
├── figure2_simulation.py            # 全脑仿真与主图生成
├── create_supplementary_pdf.py      # 补充 PDF 合成
├── generate_source_doc.py           # 源程序文档生成（软著用）
├── requirements.txt                 # Python 依赖
├── README.md                        # 项目说明
├── LICENSE                          # MIT 许可证
├── RCDT_bioRxiv_manuscript.md       # 论文手稿
├── figs/                            # 输出图像目录
│   ├── fig1_tda_validation.png
│   ├── fig2_receptor_topology.png
│   ├── fig2_supp_shuffled_control.png
│   ├── fig2_supp_bifurcation_sweep.png
│   └── fig3_persistent_entropy.png
└── docs/                            # 文档目录
    ├── 软件设计说明书.md             # 本文档
    └── source_code_for_copyright.txt # 软著源程序文档
```

**文件职责说明**：

| 文件/目录 | 职责 |
|-----------|------|
| figure1_persistence_diagram.py | TDA 管道校验，独立运行，无外部数据依赖 |
| figure2_simulation.py | 核心仿真与主图生成，支持多种命令行模式 |
| create_supplementary_pdf.py | 将 figs 下的补充图合并为单一 PDF |
| generate_source_doc.py | 生成软著登记用源程序文档，不参与科学计算 |
| requirements.txt | 声明 Python 依赖及版本约束 |
| figs/ | 所有图像输出的默认存储目录，程序自动创建 |

---

## 6. 版本历史与维护

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| V1.0 | 2026年2月 | 初始发布；包含 TDA 校验、全脑仿真、受体洗牌、分岔扫描、补充 PDF 合成 |
| V1.1 | 2026年2月 | 优化版：参数与 TDA 抽离为 rcdt_params / rcdt_tda；种子贯穿与 [D]_crit 定量；可选替代数据、多次洗牌、分岔多 seed；单元测试与复现说明 |

**维护说明**：本系统采用 MIT 许可证开源发布。用户可通过 GitHub 仓库（https://github.com/lincNK/RCDT-Model）获取最新版本、提交问题或参与贡献。

---

## 7. 附录

### 附录 A：Wilson-Cowan 微分方程

兴奋性活动 E_i 与抑制性活动 I_i 的动力学方程为：

```
τ_E · dE_i/dt = -E_i + S( G_i · ( w_EE·E_i - w_IE·I_i + Σ_j C_ij·E_j(t-τ_ij) + P_i ) )
τ_I · dI_i/dt = -I_i + S( w_EI·E_i - w_II·I_i )
```

其中 S(x) = 1/(1+e^(-x)) 为 sigmoid 函数，G_i = G_0 + k·ρ_i·[D] 为受体加权增益。

### 附录 B：持久熵计算公式

对于 H₁ 持久图中的生-死对 (b_i, d_i)，生命周期 ℓ_i = d_i - b_i，总生命周期 L = Σ ℓ_i，则：

```
PE = -Σ_i (ℓ_i/L) · log(ℓ_i/L)
```

持久熵越高表示拓扑特征寿命分布越分散；越低表示集中于少数主导特征。

### 附录 C：Takens 嵌入公式

给定标量时间序列 x(t)，嵌入维数 m、延迟 τ，重构向量为：

```
X(t) = [ x(t), x(t+τ), x(t+2τ), …, x(t+(m-1)τ) ]
```

本系统默认 m=3；τ 依数据通过互信息或自相关确定。

### 附录 D：软著登记用文档生成

执行以下命令可生成软著登记所需的源程序文档：

```bash
python generate_source_doc.py
```

**输出文件**：

| 文件 | 用途 |
|------|------|
| `docs/source_code_for_copyright.txt` | 纯文本版，含页眉及分页标记 |
| `docs/source_code_for_copyright.html` | HTML 版，用浏览器打开后按 Ctrl+P 打印为 PDF 提交 |

登记时通常要求源程序为 PDF 格式；使用 HTML 打印可保持页眉、分页与字体一致。

---

*文档结束*
